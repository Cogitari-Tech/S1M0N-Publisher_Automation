name: TruffleHog Secret Scan

on:
  pull_request:
    branches:
      - develop
      - hotfix
      - beta
      - main

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run TruffleHog Scan
        id: scan
        run: |
          set -e

          docker run --rm \
            -v "$PWD:/pwd" \
            trufflesecurity/trufflehog:latest \
            filesystem /pwd \
            --exclude-paths ".git/**" \
            --json \
            --fail \
            --no-update > trufflehog.json

      - name: Create Issue if secrets are found
        if: failure()
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          findings=$(jq -r '
            .results[] |
            "- **Arquivo:** `\(.SourceMetadata.Data.Filesystem.file)`
              **Linha:** \(.SourceMetadata.Data.Filesystem.line)
              **Tipo:** \(.DetectorName)
              üîó **Link direto:** https://github.com/'"$REPO"'/blob/'"$SHA"'/'"\(.SourceMetadata.Data.Filesystem.file)"'#L\(.SourceMetadata.Data.Filesystem.line)
            "
          ' trufflehog.json)

          payload=$(jq -n \
            --arg title "üö® TruffleHog: vazamento de segredo detectado" \
            --arg body "## üö® Vazamento de seguran√ßa detectado\n\nO TruffleHog identificou um poss√≠vel segredo neste Pull Request.\n\n### üìç Localiza√ß√£o (clique para corrigir)\n$findings\n\n### üîê A√ß√£o recomendada\n- Remover o segredo do c√≥digo\n- Rotacionar a credencial imediatamente\n- Verificar hist√≥rico de commits\n\n> ‚ÑπÔ∏è O valor do segredo **n√£o foi exposto** por motivos de seguran√ßa." \
            --argjson labels '["security"]' \
            '{title: $title, body: $body, labels: $labels}')

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d "$payload"

          exit 1
